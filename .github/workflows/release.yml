name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  QT_VERSION: '6.6.0'

jobs:
  # ===== Desktop Platforms (Linux x64, Windows x64, macOS) =====
  build-desktop:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-x64
            artifact: ArchMaths-Linux-x64.AppImage
          - os: windows-latest
            platform: windows-x64
            artifact: ArchMaths-Windows-x64.zip
          - os: macos-15
            platform: macos-arm64
            artifact: ArchMaths-macOS-ARM64.dmg

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          cache: true

      # Linux x64
      - name: Install Linux Dependencies
        if: matrix.platform == 'linux-x64'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-cursor0 \
            libxcb-icccm4 libxcb-keysyms1 libxcb-shape0 fuse libfuse2

      - name: Build (Linux)
        if: matrix.platform == 'linux-x64'
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$Qt6_DIR
          cmake --build build -j$(nproc)

      - name: Package AppImage (Linux)
        if: matrix.platform == 'linux-x64'
        run: |
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
          cp build/ArchMaths AppDir/usr/bin/
          cat > AppDir/usr/share/applications/archmaths.desktop << 'EOF'
          [Desktop Entry]
          Name=ArchMaths
          Exec=ArchMaths
          Icon=archmaths
          Type=Application
          Categories=Education;Math;
          EOF
          cp AppDir/usr/share/applications/archmaths.desktop AppDir/
          touch AppDir/usr/share/icons/hicolor/256x256/apps/archmaths.png
          ln -sf usr/share/icons/hicolor/256x256/apps/archmaths.png AppDir/archmaths.png
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          export QMAKE=$QT_ROOT_DIR/bin/qmake
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin qt --output appimage
          mv ArchMaths*.AppImage ${{ matrix.artifact }}

      # Windows x64
      - name: Build (Windows)
        if: matrix.platform == 'windows-x64'
        shell: pwsh
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release -j $env:NUMBER_OF_PROCESSORS

      - name: Package (Windows)
        if: matrix.platform == 'windows-x64'
        shell: pwsh
        run: |
          mkdir dist
          cp build/Release/ArchMaths.exe dist/
          & "$env:QT_ROOT_DIR/bin/windeployqt.exe" --release --no-translations dist/ArchMaths.exe
          Compress-Archive -Path dist/* -DestinationPath ${{ matrix.artifact }}

      # macOS
      - name: Build (macOS)
        if: startsWith(matrix.platform, 'macos')
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$Qt6_DIR
          cmake --build build -j$(sysctl -n hw.ncpu)

      - name: Package DMG (macOS)
        if: startsWith(matrix.platform, 'macos')
        run: |
          mkdir -p ArchMaths.app/Contents/MacOS
          cp build/ArchMaths ArchMaths.app/Contents/MacOS/
          cat > ArchMaths.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key><string>ArchMaths</string>
            <key>CFBundleIdentifier</key><string>com.archmaths.app</string>
            <key>CFBundleName</key><string>ArchMaths</string>
            <key>CFBundleVersion</key><string>1.0.0</string>
            <key>CFBundlePackageType</key><string>APPL</string>
          </dict>
          </plist>
          EOF
          $QT_ROOT_DIR/bin/macdeployqt ArchMaths.app -dmg
          mv ArchMaths.dmg ${{ matrix.artifact }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  # ===== Linux ARM64 =====
  build-linux-arm64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build in ARM64 container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y cmake g++ qt6-base-dev libqt6opengl6-dev libgl1-mesa-dev
          run: |
            cmake -B build -DCMAKE_BUILD_TYPE=Release
            cmake --build build -j$(nproc)
            mkdir -p dist
            cp build/ArchMaths dist/
            tar -czvf ArchMaths-Linux-ARM64.tar.gz -C dist .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Linux-ARM64.tar.gz
          path: ArchMaths-Linux-ARM64.tar.gz

  # ===== Linux LoongArch64 (Cross-compilation) =====
  build-loongarch:
    runs-on: ubuntu-24.04
    continue-on-error: true  # LoongArch64 build is experimental
    steps:
      - uses: actions/checkout@v4

      - name: Build for LoongArch64 using cross-compilation
        run: |
          set -e

          # Install cross-compilation toolchain and dependencies
          sudo apt-get update
          sudo apt-get install -y wget xz-utils cmake ninja-build pkg-config \
            qemu-user-static binfmt-support debootstrap

          # Download LoongArch64 cross-compilation toolchain
          echo "Downloading LoongArch64 cross-toolchain..."
          wget -q https://github.com/sunhaiyong1978/CLFS-for-LoongArch/releases/download/8.1/CLFS-loongarch64-8.1-x86_64-cross-tools-gcc-glibc.tar.xz -O cross-tools.tar.xz
          sudo mkdir -p /opt/cross-tools
          sudo tar -xf cross-tools.tar.xz -C /opt/cross-tools --strip-components=1

          # Download LoongArch64 sysroot with Qt6
          echo "Setting up Debian LoongArch64 sysroot..."
          sudo mkdir -p /opt/loongarch64-sysroot

          # Use debootstrap to create a minimal Debian sid loong64 sysroot
          sudo debootstrap --arch=loong64 --foreign --variant=minbase \
            --include=libqt6core6t64,libqt6gui6t64,libqt6widgets6t64,libqt6opengl6t64,libqt6openglwidgets6t64,qt6-base-dev,libgl-dev,libegl-dev \
            sid /opt/loongarch64-sysroot http://ftp.ports.debian.org/debian-ports/ || true

          # Setup cross-compilation environment
          export CROSS_ROOT=/opt/cross-tools
          export SYSROOT=/opt/loongarch64-sysroot
          export PATH=$CROSS_ROOT/bin:$PATH
          export CROSS_COMPILE=loongarch64-unknown-linux-gnu-

          # Create CMake toolchain file for LoongArch64
          cat > loongarch64-toolchain.cmake << 'TOOLCHAIN_EOF'
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR loongarch64)

          set(CROSS_ROOT /opt/cross-tools)
          set(SYSROOT /opt/loongarch64-sysroot)

          set(CMAKE_C_COMPILER ${CROSS_ROOT}/bin/loongarch64-unknown-linux-gnu-gcc)
          set(CMAKE_CXX_COMPILER ${CROSS_ROOT}/bin/loongarch64-unknown-linux-gnu-g++)
          set(CMAKE_SYSROOT ${SYSROOT})

          set(CMAKE_FIND_ROOT_PATH ${SYSROOT})
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)

          set(CMAKE_C_FLAGS_INIT "-march=loongarch64 -mabi=lp64d")
          set(CMAKE_CXX_FLAGS_INIT "-march=loongarch64 -mabi=lp64d")
          TOOLCHAIN_EOF

          # Try cross-compilation first
          if [ -f "$CROSS_ROOT/bin/loongarch64-unknown-linux-gnu-gcc" ]; then
            echo "Cross-compiler found, attempting cross-compilation..."

            # Check if Qt6 is available in sysroot
            if [ -d "$SYSROOT/usr/lib/loongarch64-linux-gnu/cmake/Qt6" ]; then
              cmake -B build -DCMAKE_BUILD_TYPE=Release \
                -DCMAKE_TOOLCHAIN_FILE=loongarch64-toolchain.cmake \
                -DCMAKE_PREFIX_PATH=$SYSROOT/usr/lib/loongarch64-linux-gnu/cmake
              cmake --build build -j$(nproc)
              mkdir -p dist
              cp build/ArchMaths dist/
              echo "Cross-compilation successful!"
            else
              echo "Qt6 not found in sysroot, falling back to QEMU chroot build..."
              # Fall back to QEMU-based build
              sudo cp /usr/bin/qemu-loongarch64-static $SYSROOT/usr/bin/ 2>/dev/null || true

              # Complete debootstrap second stage
              if [ -f "$SYSROOT/debootstrap/debootstrap" ]; then
                sudo chroot $SYSROOT /debootstrap/debootstrap --second-stage || true
              fi

              # Copy source and build
              sudo mkdir -p $SYSROOT/build
              sudo cp -r . $SYSROOT/build/

              sudo chroot $SYSROOT /bin/bash -c "
                apt-get update || true
                apt-get install -y --no-install-recommends cmake g++ qt6-base-dev libqt6opengl6-dev libgl1-mesa-dev || true
                cd /build
                cmake -B build -DCMAKE_BUILD_TYPE=Release || exit 1
                cmake --build build -j\$(nproc) || exit 1
              " && {
                mkdir -p dist
                sudo cp $SYSROOT/build/build/ArchMaths dist/
                echo "QEMU chroot build successful!"
              }
            fi
          else
            echo "Cross-compiler not found, using QEMU chroot build..."
            # QEMU-based native compilation in chroot
            sudo cp /usr/bin/qemu-loongarch64-static $SYSROOT/usr/bin/ 2>/dev/null || {
              echo "::error::QEMU loongarch64 not available"
              mkdir -p dist
              echo "LoongArch64 build requires native hardware or proper QEMU setup" > dist/README.txt
              tar -czvf ArchMaths-Linux-LoongArch64.tar.gz -C dist .
              exit 0
            }
          fi

          # Verify we have a real binary
          if [ -f "dist/ArchMaths" ] && [ $(stat -c%s "dist/ArchMaths") -gt 1000 ]; then
            file dist/ArchMaths || true
            tar -czvf ArchMaths-Linux-LoongArch64.tar.gz -C dist .
            echo "Build completed successfully!"
          else
            echo "::warning::Build produced no valid binary, creating source package for native compilation"
            mkdir -p dist/src
            cp -r src include CMakeLists.txt dist/src/
            cat > dist/README.txt << 'EOF'
          ArchMaths for LoongArch64
          =========================
          This package contains source code for native compilation on LoongArch64.

          To build:
            1. Install dependencies: apt install cmake g++ qt6-base-dev libqt6opengl6-dev libgl1-mesa-dev
            2. cd src && cmake -B build -DCMAKE_BUILD_TYPE=Release
            3. cmake --build build -j$(nproc)
            4. The binary will be at build/ArchMaths
          EOF
            tar -czvf ArchMaths-Linux-LoongArch64.tar.gz -C dist .
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Linux-LoongArch64.tar.gz
          path: ArchMaths-Linux-LoongArch64.tar.gz

  # ===== Termux (Android aarch64) =====
  build-termux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build for Termux
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y cmake g++ qt6-base-dev libqt6opengl6-dev libgles2-mesa-dev libegl1-mesa-dev
          run: |
            cmake -B build -DCMAKE_BUILD_TYPE=Release -DUSE_GLES=ON
            cmake --build build -j$(nproc)
            mkdir -p dist
            cp build/ArchMaths dist/
            tar -czvf ArchMaths-Termux-aarch64.tar.gz -C dist .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Termux-aarch64.tar.gz
          path: ArchMaths-Termux-aarch64.tar.gz

  # ===== Windows ARM64 =====
  build-windows-arm64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt Host (for windeployqt)
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          arch: win64_msvc2019_64
          cache: true
          set-env: true
          dir: '${{ runner.temp }}/qt-host'

      - name: Install Qt ARM64
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          arch: win64_msvc2019_arm64
          cache: true
          set-env: true
          dir: '${{ runner.temp }}/qt-arm64'

      - name: Build (Windows ARM64)
        shell: pwsh
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -A ARM64 -DCMAKE_PREFIX_PATH="${{ runner.temp }}/qt-arm64/Qt/${{ env.QT_VERSION }}/msvc2019_arm64"
          cmake --build build --config Release -j $env:NUMBER_OF_PROCESSORS

      - name: Package (Windows ARM64)
        shell: pwsh
        run: |
          $QT_ARM64_PATH = "${{ runner.temp }}/qt-arm64/Qt/${{ env.QT_VERSION }}/msvc2019_arm64"
          mkdir dist
          cp build/Release/ArchMaths.exe dist/
          # Manually copy ARM64 Qt DLLs (windeployqt doesn't work for cross-compilation without qtpaths)
          cp "$QT_ARM64_PATH/bin/Qt6Core.dll" dist/
          cp "$QT_ARM64_PATH/bin/Qt6Gui.dll" dist/
          cp "$QT_ARM64_PATH/bin/Qt6Widgets.dll" dist/
          cp "$QT_ARM64_PATH/bin/Qt6OpenGL.dll" dist/
          cp "$QT_ARM64_PATH/bin/Qt6OpenGLWidgets.dll" dist/
          # Copy plugins
          mkdir -p dist/platforms
          cp "$QT_ARM64_PATH/plugins/platforms/qwindows.dll" dist/platforms/
          mkdir -p dist/styles
          cp "$QT_ARM64_PATH/plugins/styles/qwindowsvistastyle.dll" dist/styles/ -ErrorAction SilentlyContinue
          Compress-Archive -Path dist/* -DestinationPath ArchMaths-Windows-ARM64.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Windows-ARM64.zip
          path: ArchMaths-Windows-ARM64.zip

  # ===== WebAssembly =====
  build-wasm:
    runs-on: ubuntu-22.04
    env:
      QT_WASM_VERSION: '6.5.3'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.25'

      - name: Install Qt Host (for moc/rcc/uic tools)
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_WASM_VERSION }}
          target: 'desktop'
          cache: true
          set-env: true
          dir: '${{ runner.temp }}/qt-host'

      - name: Install Qt WASM via aqtinstall
        run: |
          pip install aqtinstall
          aqt install-qt linux desktop ${{ env.QT_WASM_VERSION }} wasm_singlethread -O ${{ runner.temp }}/qt-wasm
          echo "=== Installed Qt WASM modules ==="
          ls -la ${{ runner.temp }}/qt-wasm/${{ env.QT_WASM_VERSION }}/wasm_singlethread/lib/cmake/ || true

      - name: Build WASM
        run: |
          QT_HOST_PATH="${{ runner.temp }}/qt-host/Qt/${{ env.QT_WASM_VERSION }}/gcc_64"
          QT_WASM_PATH="${{ runner.temp }}/qt-wasm/${{ env.QT_WASM_VERSION }}/wasm_singlethread"
          emcmake cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$QT_WASM_PATH" \
            -DQT_HOST_PATH="$QT_HOST_PATH"
          cmake --build build -j$(nproc)

      - name: Package WASM
        run: |
          mkdir -p wasm-dist
          cp build/ArchMaths.html wasm-dist/index.html 2>/dev/null || cp build/ArchMaths.html wasm-dist/ || true
          cp build/ArchMaths.js build/ArchMaths.wasm wasm-dist/ 2>/dev/null || true
          [ -f build/ArchMaths.data ] && cp build/ArchMaths.data wasm-dist/ || true
          tar -czvf ArchMaths-WebAssembly.tar.gz -C wasm-dist .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-WebAssembly.tar.gz
          path: ArchMaths-WebAssembly.tar.gz

  # ===== Release =====
  release:
    needs: [build-desktop, build-linux-arm64, build-loongarch, build-termux, build-windows-arm64, build-wasm]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/*
