name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  QT_VERSION: '6.6.0'

jobs:
  # ===== Desktop Platforms (Linux x64, Windows x64, macOS) =====
  build-desktop:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-x64
            artifact: ArchMaths-Linux-x64.AppImage
          - os: windows-latest
            platform: windows-x64
            artifact: ArchMaths-Windows-x64.zip
          - os: macos-13
            platform: macos-x64
            artifact: ArchMaths-macOS-x64.dmg
          - os: macos-14
            platform: macos-arm64
            artifact: ArchMaths-macOS-ARM64.dmg

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          cache: true

      # Linux x64
      - name: Install Linux Dependencies
        if: matrix.platform == 'linux-x64'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-cursor0 \
            libxcb-icccm4 libxcb-keysyms1 libxcb-shape0 fuse libfuse2

      - name: Build (Linux)
        if: matrix.platform == 'linux-x64'
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$Qt6_DIR
          cmake --build build -j$(nproc)

      - name: Package AppImage (Linux)
        if: matrix.platform == 'linux-x64'
        run: |
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
          cp build/ArchMaths AppDir/usr/bin/
          cat > AppDir/usr/share/applications/archmaths.desktop << 'EOF'
          [Desktop Entry]
          Name=ArchMaths
          Exec=ArchMaths
          Icon=archmaths
          Type=Application
          Categories=Education;Math;
          EOF
          cp AppDir/usr/share/applications/archmaths.desktop AppDir/
          touch AppDir/usr/share/icons/hicolor/256x256/apps/archmaths.png
          ln -sf usr/share/icons/hicolor/256x256/apps/archmaths.png AppDir/archmaths.png
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          export QMAKE=$QT_ROOT_DIR/bin/qmake
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin qt --output appimage
          mv ArchMaths*.AppImage ${{ matrix.artifact }}

      # Windows x64
      - name: Build (Windows)
        if: matrix.platform == 'windows-x64'
        shell: pwsh
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release -j $env:NUMBER_OF_PROCESSORS

      - name: Package (Windows)
        if: matrix.platform == 'windows-x64'
        shell: pwsh
        run: |
          mkdir dist
          cp build/Release/ArchMaths.exe dist/
          & "$env:QT_ROOT_DIR/bin/windeployqt.exe" --release --no-translations dist/ArchMaths.exe
          Compress-Archive -Path dist/* -DestinationPath ${{ matrix.artifact }}

      # macOS
      - name: Build (macOS)
        if: startsWith(matrix.platform, 'macos')
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$Qt6_DIR
          cmake --build build -j$(sysctl -n hw.ncpu)

      - name: Package DMG (macOS)
        if: startsWith(matrix.platform, 'macos')
        run: |
          mkdir -p ArchMaths.app/Contents/MacOS
          cp build/ArchMaths ArchMaths.app/Contents/MacOS/
          cat > ArchMaths.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key><string>ArchMaths</string>
            <key>CFBundleIdentifier</key><string>com.archmaths.app</string>
            <key>CFBundleName</key><string>ArchMaths</string>
            <key>CFBundleVersion</key><string>1.0.0</string>
            <key>CFBundlePackageType</key><string>APPL</string>
          </dict>
          </plist>
          EOF
          $QT_ROOT_DIR/bin/macdeployqt ArchMaths.app -dmg
          mv ArchMaths.dmg ${{ matrix.artifact }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  # ===== Linux ARM64 =====
  build-linux-arm64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build in ARM64 container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y cmake g++ qt6-base-dev libqt6opengl6-dev libgl1-mesa-dev
          run: |
            cmake -B build -DCMAKE_BUILD_TYPE=Release
            cmake --build build -j$(nproc)
            mkdir -p dist
            cp build/ArchMaths dist/
            tar -czvf ArchMaths-Linux-ARM64.tar.gz -C dist .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Linux-ARM64.tar.gz
          path: ArchMaths-Linux-ARM64.tar.gz

  # ===== Linux LoongArch64 =====
  build-loongarch:
    runs-on: ubuntu-22.04
    continue-on-error: true  # LoongArch build is experimental
    steps:
      - uses: actions/checkout@v4

      - name: Build for LoongArch64
        run: |
          # Install QEMU user-mode emulation
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support debootstrap

          # Download QEMU for LoongArch64 if system version doesn't support it
          if [ ! -f /usr/bin/qemu-loongarch64-static ]; then
            wget -q https://github.com/sunhaiyong1978/CLFS-for-LoongArch/releases/download/20210903/qemu-x86_64-to-loongarch64 -O qemu-loongarch64
            chmod +x qemu-loongarch64
            sudo cp qemu-loongarch64 /usr/bin/qemu-loongarch64-static
          fi

          # Register binfmt for LoongArch64
          echo ':qemu-loongarch64:M::\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x02\x01:\xff\xff\xff\xff\xff\xfe\xfe\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/usr/bin/qemu-loongarch64-static:OCF' | sudo tee /proc/sys/fs/binfmt_misc/register || true

          # Create Debian sid rootfs for LoongArch64
          sudo mkdir -p /opt/loongarch64-rootfs
          sudo debootstrap --arch=loong64 --foreign --variant=minbase sid /opt/loongarch64-rootfs http://ftp.ports.debian.org/debian-ports/ || {
            echo "::warning::debootstrap failed, trying alternative method"
            # Alternative: download pre-built rootfs
            wget -q https://github.com/sunhaiyong1978/CLFS-for-LoongArch/releases/download/2025.2/loongarch64-clfs-2025.2-sysroot.tar.xz -O sysroot.tar.xz || {
              echo "::error::Failed to get LoongArch rootfs"
              mkdir -p dist && echo "LoongArch64 build requires native compilation" > dist/README.txt
              tar -czvf ArchMaths-Linux-LoongArch64.tar.gz -C dist .
              exit 0
            }
            sudo tar -xf sysroot.tar.xz -C /opt/loongarch64-rootfs --strip-components=1
          }

          # Copy QEMU into rootfs
          sudo cp /usr/bin/qemu-loongarch64-static /opt/loongarch64-rootfs/usr/bin/ 2>/dev/null || \
          sudo mkdir -p /opt/loongarch64-rootfs/usr/bin && sudo cp /usr/bin/qemu-loongarch64-static /opt/loongarch64-rootfs/usr/bin/

          # Complete debootstrap second stage if needed
          if [ -f /opt/loongarch64-rootfs/debootstrap/debootstrap ]; then
            sudo chroot /opt/loongarch64-rootfs /debootstrap/debootstrap --second-stage || true
          fi

          # Copy source code
          sudo cp -r . /opt/loongarch64-rootfs/build

          # Mount necessary filesystems
          sudo mount -t proc proc /opt/loongarch64-rootfs/proc || true
          sudo mount -t sysfs sys /opt/loongarch64-rootfs/sys || true
          sudo mount -t devtmpfs dev /opt/loongarch64-rootfs/dev || true

          # Build inside chroot
          sudo chroot /opt/loongarch64-rootfs /bin/bash -c "
            # Try to install Qt6 if apt is available
            if command -v apt-get &> /dev/null; then
              apt-get update || true
              apt-get install -y cmake g++ qt6-base-dev libqt6opengl6-dev libgl1-mesa-dev || true
            fi

            cd /build
            # Check if Qt6 is available
            if pkg-config --exists Qt6Core 2>/dev/null || [ -d /usr/lib/loongarch64-linux-gnu/cmake/Qt6 ]; then
              cmake -B build -DCMAKE_BUILD_TYPE=Release
              cmake --build build -j\$(nproc)
              cp build/ArchMaths /tmp/
            else
              echo 'Qt6 not available, creating placeholder'
              echo 'Build natively on LoongArch64 with Qt6' > /tmp/ArchMaths
            fi
          " || {
            echo "::warning::Chroot build failed"
            mkdir -p dist && echo "Build failed - please compile natively on LoongArch64" > dist/README.txt
            tar -czvf ArchMaths-Linux-LoongArch64.tar.gz -C dist .
            exit 0
          }

          # Package
          mkdir -p dist
          sudo cp /opt/loongarch64-rootfs/tmp/ArchMaths dist/ 2>/dev/null || echo "Placeholder" > dist/ArchMaths
          tar -czvf ArchMaths-Linux-LoongArch64.tar.gz -C dist .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Linux-LoongArch64.tar.gz
          path: ArchMaths-Linux-LoongArch64.tar.gz

  # ===== Termux (Android aarch64) =====
  build-termux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build for Termux
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y cmake g++ qt6-base-dev libqt6opengl6-dev libgles2-mesa-dev libegl1-mesa-dev
          run: |
            cmake -B build -DCMAKE_BUILD_TYPE=Release -DUSE_GLES=ON
            cmake --build build -j$(nproc)
            mkdir -p dist
            cp build/ArchMaths dist/
            tar -czvf ArchMaths-Termux-aarch64.tar.gz -C dist .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Termux-aarch64.tar.gz
          path: ArchMaths-Termux-aarch64.tar.gz

  # ===== Windows ARM64 =====
  build-windows-arm64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt ARM64
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          arch: win64_msvc2019_arm64
          cache: true

      - name: Build (Windows ARM64)
        shell: pwsh
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -A ARM64
          cmake --build build --config Release -j $env:NUMBER_OF_PROCESSORS

      - name: Package (Windows ARM64)
        shell: pwsh
        run: |
          mkdir dist
          cp build/Release/ArchMaths.exe dist/
          & "$env:QT_ROOT_DIR/bin/windeployqt.exe" --release --no-translations dist/ArchMaths.exe
          Compress-Archive -Path dist/* -DestinationPath ArchMaths-Windows-ARM64.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Windows-ARM64.zip
          path: ArchMaths-Windows-ARM64.zip

  # ===== WebAssembly =====
  build-wasm:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.45'

      - name: Install Qt WASM
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          target: 'desktop'
          arch: 'wasm_singlethread'
          cache: true

      - name: Build WASM
        run: |
          emcmake cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j$(nproc)

      - name: Package WASM
        run: |
          mkdir -p wasm-dist
          cp build/ArchMaths.html wasm-dist/index.html 2>/dev/null || cp build/ArchMaths.html wasm-dist/ || true
          cp build/ArchMaths.js build/ArchMaths.wasm wasm-dist/ 2>/dev/null || true
          [ -f build/ArchMaths.data ] && cp build/ArchMaths.data wasm-dist/ || true
          tar -czvf ArchMaths-WebAssembly.tar.gz -C wasm-dist .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-WebAssembly.tar.gz
          path: ArchMaths-WebAssembly.tar.gz

  # ===== Release =====
  release:
    needs: [build-desktop, build-linux-arm64, build-loongarch, build-termux, build-windows-arm64, build-wasm]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/*
