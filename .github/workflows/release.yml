name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  QT_VERSION: '6.6.0'

jobs:
  # ===== Desktop Platforms (Linux x64, Windows x64, macOS) =====
  build-desktop:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            platform: linux-x64
            artifact: ArchMaths-Linux-x64.AppImage
          - os: windows-latest
            platform: windows-x64
            artifact: ArchMaths-Windows-x64.zip
          - os: macos-15
            platform: macos-arm64
            artifact: ArchMaths-macOS-ARM64.dmg

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          cache: true

      # Linux x64
      - name: Install Linux Dependencies
        if: matrix.platform == 'linux-x64'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-cursor0 \
            libxcb-icccm4 libxcb-keysyms1 libxcb-shape0 fuse libfuse2

      - name: Build (Linux)
        if: matrix.platform == 'linux-x64'
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$Qt6_DIR
          cmake --build build -j$(nproc)

      - name: Package AppImage (Linux)
        if: matrix.platform == 'linux-x64'
        run: |
          mkdir -p AppDir/usr/bin AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
          cp build/ArchMaths AppDir/usr/bin/
          cat > AppDir/usr/share/applications/archmaths.desktop << 'EOF'
          [Desktop Entry]
          Name=ArchMaths
          Exec=ArchMaths
          Icon=archmaths
          Type=Application
          Categories=Education;Math;
          EOF
          cp AppDir/usr/share/applications/archmaths.desktop AppDir/
          touch AppDir/usr/share/icons/hicolor/256x256/apps/archmaths.png
          ln -sf usr/share/icons/hicolor/256x256/apps/archmaths.png AppDir/archmaths.png
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy*.AppImage
          export QMAKE=$QT_ROOT_DIR/bin/qmake
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin qt --output appimage
          mv ArchMaths*.AppImage ${{ matrix.artifact }}

      # Windows x64
      - name: Build (Windows)
        if: matrix.platform == 'windows-x64'
        shell: pwsh
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release -j $env:NUMBER_OF_PROCESSORS

      - name: Package (Windows)
        if: matrix.platform == 'windows-x64'
        shell: pwsh
        run: |
          mkdir dist
          cp build/Release/ArchMaths.exe dist/
          & "$env:QT_ROOT_DIR/bin/windeployqt.exe" --release --no-translations dist/ArchMaths.exe
          Compress-Archive -Path dist/* -DestinationPath ${{ matrix.artifact }}

      # macOS
      - name: Build (macOS)
        if: startsWith(matrix.platform, 'macos')
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH=$Qt6_DIR
          cmake --build build -j$(sysctl -n hw.ncpu)

      - name: Package DMG (macOS)
        if: startsWith(matrix.platform, 'macos')
        run: |
          mkdir -p ArchMaths.app/Contents/MacOS
          cp build/ArchMaths ArchMaths.app/Contents/MacOS/
          cat > ArchMaths.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>CFBundleExecutable</key><string>ArchMaths</string>
            <key>CFBundleIdentifier</key><string>com.archmaths.app</string>
            <key>CFBundleName</key><string>ArchMaths</string>
            <key>CFBundleVersion</key><string>1.0.0</string>
            <key>CFBundlePackageType</key><string>APPL</string>
          </dict>
          </plist>
          EOF
          $QT_ROOT_DIR/bin/macdeployqt ArchMaths.app -dmg
          mv ArchMaths.dmg ${{ matrix.artifact }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  # ===== Linux ARM64 =====
  build-linux-arm64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build in ARM64 container
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y cmake g++ qt6-base-dev libqt6opengl6-dev libgl1-mesa-dev
          run: |
            cmake -B build -DCMAKE_BUILD_TYPE=Release
            cmake --build build -j$(nproc)
            mkdir -p dist
            cp build/ArchMaths dist/
            tar -czvf ArchMaths-Linux-ARM64.tar.gz -C dist .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Linux-ARM64.tar.gz
          path: ArchMaths-Linux-ARM64.tar.gz

  # ===== Linux LoongArch64 =====
  build-loongarch:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Build for LoongArch64
        run: |
          set -ex

          # Install QEMU and debootstrap
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support debootstrap debian-archive-keyring

          # Verify QEMU loongarch64 is available
          ls -la /usr/bin/qemu-loongarch64-static || {
            echo "::error::QEMU loongarch64-static not found in Ubuntu 24.04"
            exit 1
          }

          # Create Debian loong64 rootfs (first stage - just download packages)
          sudo mkdir -p /opt/loongarch64
          sudo debootstrap --arch=loong64 --foreign --variant=minbase \
            sid /opt/loongarch64 http://ftp.ports.debian.org/debian-ports/ || true

          # Copy QEMU into rootfs BEFORE second stage
          sudo mkdir -p /opt/loongarch64/usr/bin
          sudo cp /usr/bin/qemu-loongarch64-static /opt/loongarch64/usr/bin/

          # Copy debootstrap script into chroot (fix for missing /debootstrap/debootstrap)
          sudo mkdir -p /opt/loongarch64/debootstrap
          sudo cp /usr/share/debootstrap/debootstrap /opt/loongarch64/debootstrap/
          sudo cp -r /usr/share/debootstrap/functions /opt/loongarch64/debootstrap/
          sudo cp -r /usr/share/debootstrap/scripts /opt/loongarch64/debootstrap/

          # Run second stage to actually install the base system
          sudo chroot /opt/loongarch64 /debootstrap/debootstrap --second-stage

          # Configure apt sources for loong64
          sudo tee /opt/loongarch64/etc/apt/sources.list << 'SOURCES'
          deb http://ftp.ports.debian.org/debian-ports sid main
          deb http://ftp.ports.debian.org/debian-ports unreleased main
          SOURCES

          # Mount necessary filesystems
          sudo mount -t proc proc /opt/loongarch64/proc
          sudo mount -t sysfs sys /opt/loongarch64/sys
          sudo mount -t devtmpfs dev /opt/loongarch64/dev
          sudo mount -t devpts devpts /opt/loongarch64/dev/pts

          # Install build dependencies inside chroot
          sudo chroot /opt/loongarch64 /bin/bash -c "
            export DEBIAN_FRONTEND=noninteractive
            apt-get update
            apt-get install -y --no-install-recommends \
              cmake g++ make pkg-config \
              qt6-base-dev qt6-base-dev-tools libqt6opengl6-dev libqt6openglwidgets6 \
              libgl1-mesa-dev libegl1-mesa-dev
          "

          # Copy source code into chroot
          sudo mkdir -p /opt/loongarch64/build
          sudo cp -r . /opt/loongarch64/build/

          # Build inside chroot
          sudo chroot /opt/loongarch64 /bin/bash -c "
            cd /build
            cmake -B build -DCMAKE_BUILD_TYPE=Release
            cmake --build build -j\$(nproc)
          "

          # Extract the binary
          mkdir -p dist
          sudo cp /opt/loongarch64/build/build/ArchMaths dist/
          file dist/ArchMaths

          # Package
          tar -czvf ArchMaths-Linux-LoongArch64.tar.gz -C dist .
          echo "LoongArch64 build successful!"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Linux-LoongArch64.tar.gz
          path: ArchMaths-Linux-LoongArch64.tar.gz

  # ===== Termux (Android aarch64) =====
  build-termux:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Build for Termux
        uses: uraimo/run-on-arch-action@v2
        with:
          arch: aarch64
          distro: ubuntu22.04
          githubToken: ${{ github.token }}
          install: |
            apt-get update
            apt-get install -y cmake g++ qt6-base-dev libqt6opengl6-dev libgles2-mesa-dev libegl1-mesa-dev
          run: |
            cmake -B build -DCMAKE_BUILD_TYPE=Release -DUSE_GLES=ON
            cmake --build build -j$(nproc)
            mkdir -p dist
            cp build/ArchMaths dist/
            tar -czvf ArchMaths-Termux-aarch64.tar.gz -C dist .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Termux-aarch64.tar.gz
          path: ArchMaths-Termux-aarch64.tar.gz

  # ===== Windows ARM64 =====
  build-windows-arm64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt Host (for windeployqt)
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          arch: win64_msvc2019_64
          cache: true
          set-env: true
          dir: '${{ runner.temp }}/qt-host'

      - name: Install Qt ARM64
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          arch: win64_msvc2019_arm64
          cache: true
          set-env: true
          dir: '${{ runner.temp }}/qt-arm64'

      - name: Build (Windows ARM64)
        shell: pwsh
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -A ARM64 -DCMAKE_PREFIX_PATH="${{ runner.temp }}/qt-arm64/Qt/${{ env.QT_VERSION }}/msvc2019_arm64"
          cmake --build build --config Release -j $env:NUMBER_OF_PROCESSORS

      - name: Package (Windows ARM64)
        shell: pwsh
        run: |
          $QT_ARM64_PATH = "${{ runner.temp }}/qt-arm64/Qt/${{ env.QT_VERSION }}/msvc2019_arm64"
          mkdir dist
          cp build/Release/ArchMaths.exe dist/
          # Manually copy ARM64 Qt DLLs (windeployqt doesn't work for cross-compilation without qtpaths)
          cp "$QT_ARM64_PATH/bin/Qt6Core.dll" dist/
          cp "$QT_ARM64_PATH/bin/Qt6Gui.dll" dist/
          cp "$QT_ARM64_PATH/bin/Qt6Widgets.dll" dist/
          cp "$QT_ARM64_PATH/bin/Qt6OpenGL.dll" dist/
          cp "$QT_ARM64_PATH/bin/Qt6OpenGLWidgets.dll" dist/
          # Copy plugins
          mkdir -p dist/platforms
          cp "$QT_ARM64_PATH/plugins/platforms/qwindows.dll" dist/platforms/
          mkdir -p dist/styles
          cp "$QT_ARM64_PATH/plugins/styles/qwindowsvistastyle.dll" dist/styles/ -ErrorAction SilentlyContinue
          Compress-Archive -Path dist/* -DestinationPath ArchMaths-Windows-ARM64.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-Windows-ARM64.zip
          path: ArchMaths-Windows-ARM64.zip

  # ===== WebAssembly =====
  build-wasm:
    runs-on: ubuntu-22.04
    env:
      QT_WASM_VERSION: '6.5.3'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.25'

      - name: Install Qt Host (for moc/rcc/uic tools)
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_WASM_VERSION }}
          target: 'desktop'
          cache: true
          set-env: true
          dir: '${{ runner.temp }}/qt-host'

      - name: Install Qt WASM via aqtinstall
        run: |
          pip install aqtinstall
          aqt install-qt linux desktop ${{ env.QT_WASM_VERSION }} wasm_singlethread -O ${{ runner.temp }}/qt-wasm
          echo "=== Installed Qt WASM modules ==="
          ls -la ${{ runner.temp }}/qt-wasm/${{ env.QT_WASM_VERSION }}/wasm_singlethread/lib/cmake/ || true

      - name: Build WASM
        run: |
          QT_HOST_PATH="${{ runner.temp }}/qt-host/Qt/${{ env.QT_WASM_VERSION }}/gcc_64"
          QT_WASM_PATH="${{ runner.temp }}/qt-wasm/${{ env.QT_WASM_VERSION }}/wasm_singlethread"
          emcmake cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_PREFIX_PATH="$QT_WASM_PATH" \
            -DQT_HOST_PATH="$QT_HOST_PATH"
          cmake --build build -j$(nproc)

      - name: Package WASM
        run: |
          mkdir -p wasm-dist
          cp build/ArchMaths.html wasm-dist/index.html 2>/dev/null || cp build/ArchMaths.html wasm-dist/ || true
          cp build/ArchMaths.js build/ArchMaths.wasm wasm-dist/ 2>/dev/null || true
          [ -f build/ArchMaths.data ] && cp build/ArchMaths.data wasm-dist/ || true
          tar -czvf ArchMaths-WebAssembly.tar.gz -C wasm-dist .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArchMaths-WebAssembly.tar.gz
          path: ArchMaths-WebAssembly.tar.gz

  # ===== Release =====
  release:
    needs: [build-desktop, build-linux-arm64, build-loongarch, build-termux, build-windows-arm64, build-wasm]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: artifacts/*
